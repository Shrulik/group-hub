<div class="app">
  <div class="toolbar">
    <input
      type="search"
      class="toolbar__search"
      placeholder="Search groups or tabs"
      [ngModel]="searchTerm()"
      (ngModelChange)="onSearchChange($event)"
    />

    <div class="view-toggle" role="group" aria-label="View mode">
      <button type="button" class="view-toggle__btn" [class.view-toggle__btn--active]="viewMode() === 'group-only'"
              (click)="setViewMode('group-only')">
        Minimal
      </button>
      <button type="button" class="view-toggle__btn" [class.view-toggle__btn--active]="viewMode() === 'preview'"
              (click)="setViewMode('preview')">
        Preview
      </button>
      <button type="button" class="view-toggle__btn" [class.view-toggle__btn--active]="viewMode() === 'all-tabs'"
              (click)="setViewMode('all-tabs')">
        All tabs
      </button>
    </div>

    <select class="sort__input" [ngModel]="sortMode()" (ngModelChange)="onSortChange($event)">
      <option value="name-asc">Name (A‚ÜíZ)</option>
      <option value="name-desc">Name (Z‚ÜíA)</option>
      <option value="created-desc">Created (newest)</option>
      <option value="created-asc">Created (oldest)</option>
    </select>
  </div>

  @if (statusMessage(); as status) {
    <section class="status" [class.status--error]="status.tone === 'error'"
      [class.status--success]="status.tone === 'success'">
      {{ status.text }}
    </section>
  }

  <div class="content">
    @if (loading()) {
      <div class="loading">Refreshing tab groups‚Ä¶</div>
    } @else {
      @if (filteredGroups().length === 0) {
        <div class="empty">
          @if (searchActive()) {
            <p>No groups match your search.</p>
          } @else {
            <p>No tab groups found. Create a group in Chrome to get started.</p>
          }
        </div>
      } @else {
        @if (viewMode() === 'group-only') {
          <div class="group-gallery">
            @for (entry of filteredGroups(); track entry.group.id) {
              <article class="group-chip" [ngStyle]="chipStyles(entry.group.color)">
                <span class="group-chip__dot" [style.background]="colorFor(entry.group.color)"></span>
                <button type="button" class="group-chip__title"
                  (click)="activateGroup(entry.group.id, $event)"
                  [innerHTML]="toggleHighlightTerm(entry.group.title || 'Untitled group')"></button>
                <div class="group-chip__actions">
                  @if (hasSelection()) {
                    <button type="button" class="group-chip__move"
                      (click)="moveSelectionToGroup(entry.group.id, $event)"
                      [disabled]="selectionAlreadyInGroup(entry)"
                      title="Move selected tabs here">‚á¢
                    </button>
                  }
                  <button type="button" class="group-chip__toggle"
                    (click)="toggleGroupExpansion(entry.group.id); $event.stopPropagation()"
                    [title]="isExpanded(entry.group.id) ? 'Hide details' : 'Show details'">
                    @if (isExpanded(entry.group.id)) {
                      ‚è∂
                    } @else {
                      ‚è∑
                    }
                  </button>
                  <button type="button" class="group-chip__open" (click)="activateGroup(entry.group.id, $event)"
                    title="Open group">‚Üó
                  </button>
                </div>
              </article>
              @if (isExpanded(entry.group.id)) {
                <div class="group-panel">
                  <div class="group-panel__meta">
                    {{ entry.group.tabCount }} tabs ¬∑ Created {{ formatTimestamp(entry.group.createdAt) }}
                  </div>
                  @if (previewTabs(entry).length > 0) {
                    <ul class="group-panel__tabs">
                      @for (tab of previewTabs(entry); track tab.id) {
                        <li class="group-panel__tab">
                          <span class="group-panel__icon">
                            @if (tab.favIconUrl) {
                              <img [src]="tab.favIconUrl" alt="" />
                            } @else {
                              <span class="tabs__placeholder">üóÇ</span>
                            }
                          </span>
                          <div class="group-panel__details">
                            <div class="group-panel__title">{{ tab.title || 'Untitled tab' }}</div>
                            <div
                              class="group-panel__url"
                              [innerHTML]="toggleHighlightTerm(tab.url || '')"
                              [title]="tab.url"
                            ></div>
                          </div>
                        </li>
                      }
                    </ul>
                  }
                  <div class="group-panel__actions">
                    <button type="button" class="group-panel__link" (click)="setViewMode('preview')">
                      Open preview view
                    </button>
                  </div>
                </div>
              }
            }
          </div>
        } @else {
          <section class="list list--full">
            @for (entry of filteredGroups(); track entry.group.id) {
              <article class="group">
                <header class="group__header">
                  <span class="group__color" [style.background]="colorFor(entry.group.color)"></span>
                  <div class="group__titles">
                    <div class="group__name" [innerHTML]="toggleHighlightTerm(entry.group.title || 'Untitled group')"></div>
                    <div class="group__meta">
                      <span class="group__meta-item">{{ entry.group.tabCount }} tabs</span>
                      <span class="group__meta-item">Created {{ formatTimestamp(entry.group.createdAt) }}</span>
                    </div>
                  </div>
                <div class="group__actions">
                  @if (hasSelection()) {
                    <button type="button" class="group__move"
                      (click)="moveSelectionToGroup(entry.group.id, $event)"
                      [disabled]="selectionAlreadyInGroup(entry)"
                      title="Move selected tabs here">‚á¢
                    </button>
                  }
                  <button type="button" class="group__action" (click)="activateGroup(entry.group.id, $event)">
                    Open
                  </button>
                  <button type="button" class="group__toggle" (click)="toggleGroupExpansion(entry.group.id)">
                    {{ groupToggleLabel(entry.group.id) }}
                    </button>
                  </div>
                </header>

                @if (visibleTabsForGroup(entry).length > 0) {
                  <ul class="tabs">
                    @for (tab of visibleTabsForGroup(entry); track tab.id) {
                      <li class="tabs__item">
                        <span class="tabs__icon">
                          @if (tab.favIconUrl) {
                            <img [src]="tab.favIconUrl" alt="" />
                          } @else {
                            <span class="tabs__placeholder">üóÇ</span>
                          }
                        </span>
                        <div class="tabs__details">
                          <div class="tabs__title" [innerHTML]="toggleHighlightTerm(tab.title || 'Untitled tab')"></div>
                          <div
                            class="tabs__url"
                            [innerHTML]="toggleHighlightTerm(tab.url || '')"
                            [title]="tab.url"
                          ></div>
                        </div>
                      </li>
                    }
                  </ul>
                }

                @if (hiddenTabCount(entry) > 0) {
                  <button type="button" class="group__show-more" (click)="expandGroupFully(entry.group.id)">
                    Show {{ hiddenTabCount(entry) }} more
                  </button>
                }
              </article>
            }
          </section>
        }
      }
    }
  </div>

  <div class="utility-menu" *ngIf="utilityMenuOpen()">
    <button type="button" class="utility-menu__btn" (click)="triggerExport()">Export current view</button>
    <button type="button" class="utility-menu__btn" (click)="openImport()">Import from file</button>
  </div>

  <footer class="footer">
    <span class="footer__summary">{{ infoSummary() }}</span>
    <div class="footer__actions">
      @if (undoAvailable()) {
        <span class="footer__move-status">
          {{ lastMoveStatusText() }}
          <button type="button" class="footer__undo" (click)="undoLastMove()">Undo</button>
        </span>
      }
      <button type="button" class="footer__gear" (click)="toggleUtilityMenu()" title="Utilities">‚öôÔ∏é</button>
    </div>
  </footer>

  <input type="file" accept="application/json" class="import-input" #importInput
    (change)="handleImportSelected($event)" />
</div>
